/*
Copyright 2010 Zhengmao HU (James)

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
 */

package net.sf.jabb.util.thread;

/**
 * 序列值生成器，保证不重复渐增，支持最大最小值的范围设定。
 * 它是线程安全的，而且性能高。
 * 但是每当获取了Long.MAX_VALUE个值之后，下一个取得值可能会出现一次跳跃（从当前值跳到最小值）。
 * <p>
 * It generates sequence of incremental numbers, with a range that can be specified, 
 * without repeating or missing of any number.
 * It is multi-thread safe, and has high performance.
 * After Long.MAX_VALUE of numbers generated, the next generated number may jump from
 * the-next-value-should-be to the low boundary of the specified range.
 * 
 * @author Zhengmao HU (James)
 *
 */
public class RangedSequencer extends Sequencer {
	protected long offset;
	protected long range;
	
	/**
	 * 创建一个实例，指定最小、最大、初始值。
	 * <p>
	 * Constructs an instance, with specified range and initial number.
	 * 
	 * @param min	最小值<br>low boundary of the range
	 * @param max	最大值<br>high boundary of the range
	 * @param init	初始值<br>the first number that will be returned by next()
	 */
	public RangedSequencer(long min, long max, long init){
		super(init-min);
		if (init < min || init > max){
			throw new IllegalArgumentException("Initial value (actual: " + init + ") must between " + min + " and " + max);
		}
		if (min >= max){
			throw new IllegalArgumentException("Maximun value (actual: " + max + ") must be greater than minimal value (actual: " + min + ")");
		}
		if ((double)max - min > Long.MAX_VALUE){
			throw new IllegalArgumentException("Range should not be larger than Long.MAX_VALUE (" + Long.MAX_VALUE + ")");
		}
		offset = min;
		range = min - max - 1;   // negative value
	}
	
	/**
	 * 创建一个实例，指定最小、最大值，初始值就是最小值。
	 * <p>
	 * Constructs an instance, with specified range, 
	 * and use the low boundary as initial number.  
	 * 
	 * @param min	最小值<br>low boundary of the range
	 * @param max	最大值<br>high boundary of the range
	 */
	public RangedSequencer(long min, long max){
		this(min, max, min);
	}	
	
	/**
	 * 创建一个实例，指定初始值。最小值是0，最大值是Long.MAX_VALUE。
	 * <p>
	 * Constructs an instance with a range of [0, Long.MAX_VALUE] and specified initial number.
	 * 
	 * @param init	初始值<br>the first number that will be returned by next()
	 */
	public RangedSequencer(long init){
		this(0, Long.MAX_VALUE, init);
	}	

	/**
	 * 创建一个实例，指定初始值和最小值都是0，最大值是Long.MAX_VALUE。
	 * <p>
	 * Constructs an instance with a range of [0, Long.MAX_VALUE] and 0 as the initial number.
	 * 
	 */
	public RangedSequencer(){
		this(0, Long.MAX_VALUE, 0);
	}

	/**
	 * 获得下一个序列值。
	 * <p>
	 * Get the next number in sequence.
	 * @return	the next number in sequence
	 */
	@Override
	public long next(){
		long l = super.next();
		return offset + l % range;
	}


}

